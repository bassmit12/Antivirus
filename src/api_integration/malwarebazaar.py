"""MalwareBazaar API integration."""
from __future__ import annotations

import logging
from typing import Optional

import requests

from ..config import config
from .cache_manager import CacheManager

logger = logging.getLogger(__name__)

MALWAREBAZAAR_API_URL = "https://mb-api.abuse.ch/api/v1/"


class MalwareBazaarClient:
    """Client for MalwareBazaar API."""
    
    def __init__(self):
        self.enabled = config.get('api.malwarebazaar.enabled', True)
        self.cache = CacheManager(ttl_hours=config.get('api.malwarebazaar.cache_duration_hours', 24))
        self.timeout = config.get('api.malwarebazaar.timeout', 10)
        
    def lookup_hash(self, file_hash: str) -> Optional[dict]:
        """
        Look up a file hash in MalwareBazaar.
        
        Args:
            file_hash: SHA-256 hash of the file
            
        Returns:
            Dictionary with detection results or None if not found/error
        """
        if not self.enabled:
            return None
            
        # Check cache first
        cached = self.cache.get(file_hash)
        if cached is not None:
            logger.debug(f"Cache hit for hash: {file_hash[:16]}...")
            return cached
            
        try:
            response = requests.post(
                MALWAREBAZAAR_API_URL,
                data={'query': 'get_info', 'hash': file_hash},
                timeout=self.timeout
            )
            response.raise_for_status()
            
            data = response.json()
            
            if data.get('query_status') == 'ok':
                result = self._parse_response(data)
                self.cache.set(file_hash, result)
                return result
            elif data.get('query_status') == 'hash_not_found':
                result = {'found': False}
                self.cache.set(file_hash, result)
                return result
            else:
                logger.warning(f"MalwareBazaar query failed: {data.get('query_status')}")
                return None
                
        except requests.RequestException as e:
            logger.error(f"Error querying MalwareBazaar: {e}")
            return None
        except Exception as e:
            logger.error(f"Unexpected error in MalwareBazaar lookup: {e}")
            return None
            
    def _parse_response(self, data: dict) -> dict:
        """Parse MalwareBazaar API response."""
        if not data.get('data'):
            return {'found': False}
            
        info = data['data'][0]  # Get first result
        
        return {
            'found': True,
            'signature': info.get('signature'),
            'file_type': info.get('file_type'),
            'file_name': info.get('file_name'),
            'tags': info.get('tags', []),
            'first_seen': info.get('first_seen'),
            'reporter': info.get('reporter'),
            'origin_country': info.get('origin_country'),
        }
        
    def is_malicious(self, file_hash: str) -> bool:
        """
        Check if a file is in MalwareBazaar database.
        
        Args:
            file_hash: SHA-256 hash of the file
            
        Returns:
            True if found in MalwareBazaar (indicates malware)
        """
        result = self.lookup_hash(file_hash)
        return result is not None and result.get('found', False)
